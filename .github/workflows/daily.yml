name: Daily arXiv Fetch

on:
  schedule:
    - cron: '0 4 * * *'
  workflow_dispatch:

jobs:
  fetch:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # æ·»åŠ æƒé™å£°æ˜
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        pip install -r requirements.txt
    
    - name: Run fetch script
      run: |
        echo "å¼€å§‹è·å–arXivè®ºæ–‡..."
        python fetch_papers.py
        echo "ç”Ÿæˆçš„æ–‡ä»¶:"
        ls -la *.tex
        echo "Daily Tex Documents æ–‡ä»¶å¤¹å†…å®¹:"
        ls -la "Daily Tex Documents"/
    
    - name: Commit and push changes
      run: |
        # é…ç½®Gitç”¨æˆ·
        git config --global user.name 'GitHub Actions Bot'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        
        # æ·»åŠ æ‰€æœ‰ .tex æ–‡ä»¶ï¼ŒåŒ…æ‹¬å­ç›®å½•ä¸­çš„
        git add *.tex "Daily Tex Documents"/*.tex
        
        # æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦æäº¤çš„æ›´æ”¹
        if git diff --cached --quiet; then
          echo "æ²¡æœ‰æ–‡ä»¶å˜åŒ–ï¼Œæ— éœ€æäº¤"
        else
          echo "æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–ï¼Œå‡†å¤‡æäº¤"
          # å…ˆæ‹‰å–æœ€æ–°æ›´æ”¹ï¼Œé¿å…å†²çª
          git pull --rebase origin main || echo "æ‹‰å–å¤±è´¥ï¼Œç»§ç»­æ¨é€"
          git commit -m "è‡ªåŠ¨æ›´æ–°arXivè®ºæ–‡ - $(date +'%Y-%m-%d %H:%M')"
          git push origin main
          echo "âœ… å·²æäº¤å¹¶æ¨é€æ›´æ”¹"
        fi
    
    - name: Upload generated files as artifacts
      uses: actions/upload-artifact@v4
      with:
        name: arxiv-papers
        path: |
          latest.tex
          "Daily Tex Documents"/arxiv_*.tex
        retention-days: 7
    
    - name: Show success message
      run: |
        echo "âœ… arXivè®ºæ–‡è·å–å®Œæˆï¼"
        echo "ğŸ“„ latest.tex åœ¨æ ¹ç›®å½•"
        echo "ğŸ“ å†å²æ–‡ä»¶åœ¨ Daily Tex Documents æ–‡ä»¶å¤¹"
        echo "ğŸ“¦ æ–‡ä»¶å¯åœ¨Artifactsä¸­ä¸‹è½½"
        echo "â° ä¸‹æ¬¡è¿è¡Œæ—¶é—´ï¼šæ˜å¤©UTC 6:00ï¼ˆåŒ—äº¬æ—¶é—´14:00ï¼‰"

